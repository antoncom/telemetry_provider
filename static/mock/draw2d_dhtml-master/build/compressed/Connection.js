/**
This notice must be untouched at all times.
This is the COMPRESSED version of Draw2D
WebSite: http://www.draw2d.org
Copyright: 2006 Andreas Herz. All rights reserved.
Created: 5.11.2006 by Andreas Herz (Web: http://www.freegroup.de )
LICENSE: LGPL
**/

draw2d.Connection=function(){draw2d.Line.call(this);this.sourcePort=null;this.targetPort=null;this.canDrag=true;this.sourceDecorator=null;this.targetDecorator=null;this.sourceAnchor=new draw2d.ConnectionAnchor();this.targetAnchor=new draw2d.ConnectionAnchor();this.router=draw2d.Connection.defaultRouter;this.lineSegments=new draw2d.ArrayList();this.children=new draw2d.ArrayList();this.setColor(new draw2d.Color(0,0,115));this.setLineWidth(1);};draw2d.Connection.prototype=new draw2d.Line();draw2d.Connection.prototype.type="draw2d.Connection";draw2d.Connection.defaultRouter=new draw2d.ManhattanConnectionRouter();draw2d.Connection.setDefaultRouter=function(_6c3){draw2d.Connection.defaultRouter=_6c3;};draw2d.Connection.prototype.disconnect=function(){if(this.sourcePort!==null){this.sourcePort.detachMoveListener(this);this.fireSourcePortRouteEvent();}if(this.targetPort!==null){this.targetPort.detachMoveListener(this);this.fireTargetPortRouteEvent();}};draw2d.Connection.prototype.reconnect=function(){if(this.sourcePort!==null){this.sourcePort.attachMoveListener(this);this.fireSourcePortRouteEvent();}if(this.targetPort!==null){this.targetPort.attachMoveListener(this);this.fireTargetPortRouteEvent();}};draw2d.Connection.prototype.isResizeable=function(){return this.getCanDrag();};draw2d.Connection.prototype.setCanDrag=function(flag){this.canDrag=flag;};draw2d.Connection.prototype.getCanDrag=function(){return this.canDrag;};draw2d.Connection.prototype.addFigure=function(_6c5,_6c6){var _6c7={};_6c7.figure=_6c5;_6c7.locator=_6c6;this.children.add(_6c7);if(this.graphics!==null){this.paint();}var _6c8=this;var _6c9=function(){var _6ca=arguments[0]||window.event;_6ca.returnValue=false;_6c8.getWorkflow().setCurrentSelection(_6c8);_6c8.getWorkflow().showLineResizeHandles(_6c8);};if(_6c5.getHTMLElement().addEventListener){_6c5.getHTMLElement().addEventListener("mousedown",_6c9,false);}else{if(_6c5.getHTMLElement().attachEvent){_6c5.getHTMLElement().attachEvent("onmousedown",_6c9);}}};draw2d.Connection.prototype.setSourceDecorator=function(_6cb){this.sourceDecorator=_6cb;if(this.graphics!==null){this.paint();}};draw2d.Connection.prototype.getSourceDecorator=function(){return this.sourceDecorator;};draw2d.Connection.prototype.setTargetDecorator=function(_6cc){this.targetDecorator=_6cc;if(this.graphics!==null){this.paint();}};draw2d.Connection.prototype.getTargetDecorator=function(){return this.targetDecorator;};draw2d.Connection.prototype.setSourceAnchor=function(_6cd){this.sourceAnchor=_6cd;this.sourceAnchor.setOwner(this.sourcePort);if(this.graphics!==null){this.paint();}};draw2d.Connection.prototype.setTargetAnchor=function(_6ce){this.targetAnchor=_6ce;this.targetAnchor.setOwner(this.targetPort);if(this.graphics!==null){this.paint();}};draw2d.Connection.prototype.setRouter=function(_6cf){if(_6cf!==null){this.router=_6cf;}else{this.router=new draw2d.NullConnectionRouter();}if(this.graphics!==null){this.paint();}};draw2d.Connection.prototype.getRouter=function(){return this.router;};draw2d.Connection.prototype.setWorkflow=function(_6d0){draw2d.Line.prototype.setWorkflow.call(this,_6d0);for(var i=0;i<this.children.getSize();i++){this.children.get(i).isAppended=false;}};draw2d.Connection.prototype.paint=function(){if(this.html===null){return;}try{for(var i=0;i<this.children.getSize();i++){var _6d3=this.children.get(i);if(_6d3.isAppended==true){this.html.removeChild(_6d3.figure.getHTMLElement());}_6d3.isAppended=false;}if(this.graphics===null){this.graphics=new jsGraphics(this.html);}else{this.graphics.clear();}this.graphics.setStroke(this.stroke);this.graphics.setColor(this.lineColor.getHTMLStyle());this.startStroke();this.router.route(this);if(this.getSource().getParent().isMoving==false&&this.getTarget().getParent().isMoving==false){if(this.targetDecorator!==null){this.targetDecorator.paint(new draw2d.Graphics(this.graphics,this.getEndAngle(),this.getEndPoint()));}if(this.sourceDecorator!==null){this.sourceDecorator.paint(new draw2d.Graphics(this.graphics,this.getStartAngle(),this.getStartPoint()));}}this.finishStroke();for(var i=0;i<this.children.getSize();i++){var _6d3=this.children.get(i);this.html.appendChild(_6d3.figure.getHTMLElement());_6d3.isAppended=true;_6d3.locator.relocate(_6d3.figure);}}catch(e){pushErrorStack(e,"draw2d.Connection.prototype.paint=function()");}};draw2d.Connection.prototype.getStartPoint=function(){if(this.isMoving==false){return this.sourceAnchor.getLocation(this.targetAnchor.getReferencePoint());}else{return draw2d.Line.prototype.getStartPoint.call(this);}};draw2d.Connection.prototype.getEndPoint=function(){if(this.isMoving==false){return this.targetAnchor.getLocation(this.sourceAnchor.getReferencePoint());}else{return draw2d.Line.prototype.getEndPoint.call(this);}};draw2d.Connection.prototype.startStroke=function(){this.oldPoint=null;this.lineSegments=new draw2d.ArrayList();};draw2d.Connection.prototype.finishStroke=function(){this.graphics.paint();this.oldPoint=null;};draw2d.Connection.prototype.getPoints=function(){var _6d4=new draw2d.ArrayList();var line=null;for(var i=0;i<this.lineSegments.getSize();i++){line=this.lineSegments.get(i);_6d4.add(line.start);}if(line!==null){_6d4.add(line.end);}return _6d4;};draw2d.Connection.prototype.addPoint=function(p){p=new draw2d.Point(parseInt(p.x),parseInt(p.y));if(this.oldPoint!==null){this.graphics.drawLine(this.oldPoint.x,this.oldPoint.y,p.x,p.y);var line={};line.start=this.oldPoint;line.end=p;this.lineSegments.add(line);}this.oldPoint={};this.oldPoint.x=p.x;this.oldPoint.y=p.y;};draw2d.Connection.prototype.refreshSourcePort=function(){var _6d9=this.getModel().getSourceModel();var _6da=this.getModel().getSourcePortName();var _6db=this.getWorkflow().getDocument().getFigures();var _6dc=_6db.getSize();for(var i=0;i<_6dc;i++){var _6de=_6db.get(i);if(_6de.getModel()==_6d9){var port=_6de.getOutputPort(_6da);this.setSource(port);}}this.setRouter(this.getRouter());};draw2d.Connection.prototype.refreshTargetPort=function(){var _6e0=this.getModel().getTargetModel();var _6e1=this.getModel().getTargetPortName();var _6e2=this.getWorkflow().getDocument().getFigures();var _6e3=_6e2.getSize();for(var i=0;i<_6e3;i++){var _6e5=_6e2.get(i);if(_6e5.getModel()==_6e0){var port=_6e5.getInputPort(_6e1);this.setTarget(port);}}this.setRouter(this.getRouter());};draw2d.Connection.prototype.setSource=function(port){if(this.sourcePort!==null){this.sourcePort.detachMoveListener(this);}this.sourcePort=port;if(this.sourcePort===null){return;}this.sourceAnchor.setOwner(this.sourcePort);this.fireSourcePortRouteEvent();this.sourcePort.attachMoveListener(this);this.setStartPoint(port.getAbsoluteX(),port.getAbsoluteY());};draw2d.Connection.prototype.getSource=function(){return this.sourcePort;};draw2d.Connection.prototype.setTarget=function(port){if(this.targetPort!==null){this.targetPort.detachMoveListener(this);}this.targetPort=port;if(this.targetPort===null){return;}this.targetAnchor.setOwner(this.targetPort);this.fireTargetPortRouteEvent();this.targetPort.attachMoveListener(this);this.setEndPoint(port.getAbsoluteX(),port.getAbsoluteY());};draw2d.Connection.prototype.getTarget=function(){return this.targetPort;};draw2d.Connection.prototype.onOtherFigureMoved=function(_6e9){if(_6e9==this.sourcePort){this.setStartPoint(this.sourcePort.getAbsoluteX(),this.sourcePort.getAbsoluteY());}else{this.setEndPoint(this.targetPort.getAbsoluteX(),this.targetPort.getAbsoluteY());}};draw2d.Connection.prototype.containsPoint=function(px,py){for(var i=0;i<this.lineSegments.getSize();i++){var line=this.lineSegments.get(i);if(draw2d.Line.hit(this.corona,line.start.x,line.start.y,line.end.x,line.end.y,px,py)){return true;}}return false;};draw2d.Connection.prototype.getStartAngle=function(){var p1=this.lineSegments.get(0).start;var p2=this.lineSegments.get(0).end;if(this.router instanceof draw2d.BezierConnectionRouter){p2=this.lineSegments.get(5).end;}var _6f0=Math.sqrt((p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y));var _6f1=-(180/Math.PI)*Math.asin((p1.y-p2.y)/_6f0);if(_6f1<0){if(p2.x<p1.x){_6f1=Math.abs(_6f1)+180;}else{_6f1=360-Math.abs(_6f1);}}else{if(p2.x<p1.x){_6f1=180-_6f1;}}return _6f1;};draw2d.Connection.prototype.getEndAngle=function(){if(this.lineSegments.getSize()===0){return 90;}var p1=this.lineSegments.get(this.lineSegments.getSize()-1).end;var p2=this.lineSegments.get(this.lineSegments.getSize()-1).start;if(this.router instanceof draw2d.BezierConnectionRouter){p2=this.lineSegments.get(this.lineSegments.getSize()-5).end;}var _6f4=Math.sqrt((p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y));var _6f5=-(180/Math.PI)*Math.asin((p1.y-p2.y)/_6f4);if(_6f5<0){if(p2.x<p1.x){_6f5=Math.abs(_6f5)+180;}else{_6f5=360-Math.abs(_6f5);}}else{if(p2.x<p1.x){_6f5=180-_6f5;}}return _6f5;};draw2d.Connection.prototype.fireSourcePortRouteEvent=function(){var _6f6=this.sourcePort.getConnections();for(var i=0;i<_6f6.getSize();i++){_6f6.get(i).paint();}};draw2d.Connection.prototype.fireTargetPortRouteEvent=function(){var _6f8=this.targetPort.getConnections();for(var i=0;i<_6f8.getSize();i++){_6f8.get(i).paint();}};draw2d.Connection.prototype.createCommand=function(_6fa){if(_6fa.getPolicy()==draw2d.EditPolicy.MOVE){return new draw2d.CommandReconnect(this);}if(_6fa.getPolicy()==draw2d.EditPolicy.DELETE){if(this.isDeleteable()==true){return new draw2d.CommandDelete(this);}return null;}return null;};